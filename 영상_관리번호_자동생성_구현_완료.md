# μμƒ κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± κµ¬ν„ μ™„λ£ λ³΄κ³ μ„

## β… μ™„λ£λ μ‘μ—…

### 1. κ΄€λ¦¬λ²νΈ μƒμ„± ν•¨μ κµ¬ν„ (db.js)
- β… **`generateManagementNo()` ν•¨μ μ¶”κ°€**
  - ν¬λ§·: YYMMDD-001 (μ: 251216-001)
  - λ™μΌ λ‚ μ§ λ‚΄μ—μ„ μλ²μ΄ 001λ¶€ν„° 1μ”© μ¦κ°€
  - νΈλμ­μ…μ„ μ‚¬μ©ν•μ—¬ λ™μ‹ λ“±λ΅μ—λ„ μ¤‘λ³µμ΄ λ°μƒν•μ§€ μ•λ„λ΅ μ›μμ  μ²λ¦¬

### 2. DB μ¤ν‚¤λ§ λ§μ΄κ·Έλ μ΄μ… (db.js)
- β… **`management_id` μ»¬λΌ μ¶”κ°€** (μ—†μΌλ©΄)
- β… **unique μΈλ±μ¤ μ¶”κ°€** (`idx_videos_management_id`)
  - NULL κ°’μ€ μΈλ±μ¤μ—μ„ μ μ™Έ (WHERE management_id IS NOT NULL)

### 3. Video μƒμ„± μ—”λ“ν¬μΈνΈ μμ •
- β… **POST /admin/videos** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€
- β… **POST /videos/bulk** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€
- β… **POST /videos/batch** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€
- β… **POST /videos** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€

### 4. μ‘λ‹µ ν•„λ“ ν™•μΈ
- β… **GET /admin/videos** - `management_id` ν•„λ“ ν¬ν•¨ (μ΄λ―Έ κµ¬ν„λ¨)
- β… **GET /videos** - `management_id` ν•„λ“ ν¬ν•¨ (μ΄λ―Έ κµ¬ν„λ¨)

## π”’ μ μ©λ μμ • μ‚¬ν•­

### db.js - κ΄€λ¦¬λ²νΈ μƒμ„± ν•¨μ

```javascript
/**
 * μμƒ κ΄€λ¦¬λ²νΈ μƒμ„± (YYMMDD-001 ν•μ‹)
 * λ™μΌ λ‚ μ§ λ‚΄μ—μ„ μλ²μ΄ μλ™μΌλ΅ μ¦κ°€ν•λ©°, λ™μ‹ λ“±λ΅μ—λ„ μ¤‘λ³µμ΄ λ°μƒν•μ§€ μ•λ„λ΅ μ›μμ  μ²λ¦¬
 * @returns {string} κ΄€λ¦¬λ²νΈ (μ: "251216-001")
 */
export function generateManagementNo() {
  // ν„μ¬ λ‚ μ§λ¥Ό YYMMDD ν•μ‹μΌλ΅ λ³€ν™
  const now = new Date();
  const year = String(now.getFullYear()).slice(-2); // λ§μ§€λ§‰ 2μλ¦¬
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const datePrefix = `${year}${month}${day}`;
  
  // νΈλμ­μ…μ„ μ‚¬μ©ν•μ—¬ μ›μμ  μ¦κ°€ λ³΄μ¥
  const transaction = db.transaction(() => {
    // μ¤λ λ‚ μ§λ΅ μ‹μ‘ν•λ” κ΄€λ¦¬λ²νΈ μ¤‘ κ°€μ¥ ν° μλ² μ΅°ν
    const maxNo = db
      .prepare(
        `SELECT management_id FROM videos 
         WHERE management_id LIKE ? 
         ORDER BY management_id DESC 
         LIMIT 1`
      )
      .get(`${datePrefix}-%`);
    
    let nextSequence = 1;
    
    if (maxNo && maxNo.management_id) {
      // κΈ°μ΅΄ κ΄€λ¦¬λ²νΈμ—μ„ μλ² μ¶”μ¶ (μ: "251216-001" -> 1)
      const match = maxNo.management_id.match(/-(\d+)$/);
      if (match) {
        const lastSequence = parseInt(match[1], 10);
        nextSequence = lastSequence + 1;
      }
    }
    
    // μλ²μ„ 3μλ¦¬ λ¬Έμμ—΄λ΅ ν¬λ§·ν… (001, 002, ...)
    const sequenceStr = String(nextSequence).padStart(3, '0');
    const managementNo = `${datePrefix}-${sequenceStr}`;
    
    return managementNo;
  });
  
  // νΈλμ­μ… μ‹¤ν–‰ (μ›μμ  λ³΄μ¥)
  return transaction();
}
```

### db.js - DB μ¤ν‚¤λ§ λ§μ΄κ·Έλ μ΄μ…

```javascript
// videos ν…μ΄λΈ”μ— management_id μ»¬λΌ μ¶”κ°€ (μ—†μΌλ©΄)
try {
  const videosTableInfo = db.prepare("PRAGMA table_info('videos')").all();
  const videosColumns = videosTableInfo.map((col) => col.name);
  
  if (!videosColumns.includes("management_id")) {
    db.exec("ALTER TABLE videos ADD COLUMN management_id TEXT");
    console.log("β… videos ν…μ΄λΈ”μ— management_id μ»¬λΌ μ¶”κ°€λ¨");
  }
  
  // management_idμ— unique μΈλ±μ¤ μ¶”κ°€ (μ—†μΌλ©΄)
  try {
    db.exec("CREATE UNIQUE INDEX IF NOT EXISTS idx_videos_management_id ON videos(management_id) WHERE management_id IS NOT NULL");
    console.log("β… videos ν…μ΄λΈ”μ— management_id unique μΈλ±μ¤ μ¶”κ°€λ¨");
  } catch (err) {
    if (!err.message.includes("already exists")) {
      console.warn("β οΈ  management_id μΈλ±μ¤ μƒμ„± μ‹¤ν¨:", err.message);
    }
  }
} catch (err) {
  console.warn("β οΈ  videos ν…μ΄λΈ” management_id μ»¬λΌ/μΈλ±μ¤ μ¶”κ°€ μ‹¤ν¨:", err.message);
}
```

### server.js - Video μƒμ„± μ—”λ“ν¬μΈνΈ μμ •

**λ¨λ“  video μƒμ„± μ—”λ“ν¬μΈνΈμ— μ¶”κ°€λ μ½”λ“**:

```javascript
// κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± (μ—†μΌλ©΄)
let managementNo = null;
try {
  managementNo = generateManagementNo();
  console.log(`[${routeName}] κ΄€λ¦¬λ²νΈ μλ™ μƒμ„±: ${managementNo}`);
} catch (err) {
  console.warn(`[${routeName}] κ΄€λ¦¬λ²νΈ μƒμ„± μ‹¤ν¨, nullλ΅ μ €μ¥:`, err.message);
  // κ΄€λ¦¬λ²νΈ μƒμ„± μ‹¤ν¨ν•΄λ„ μμƒ μƒμ„±μ€ κ³„μ† μ§„ν–‰
}

// INSERT λ¬Έμ— management_id μ¶”κ°€
db.prepare(
  "INSERT INTO videos (id, site_id, owner_id, platform, video_id, source_url, title, thumbnail_url, embed_url, language, status, visibility, management_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)"
).run(
  videoId,
  targetSiteId,
  targetOwnerId,
  platform,
  extractedVideoId,
  normalizedSourceUrl,
  metadata.title,
  metadata.thumbnail_url,
  metadata.embed_url,
  language,
  status,
  visibility,
  managementNo // κ΄€λ¦¬λ²νΈ μ¶”κ°€
);
```

## π“ κ΄€λ¦¬λ²νΈ μƒμ„± λ΅μ§

### ν¬λ§·
- **ν•μ‹**: `YYMMDD-XXX`
- **μμ‹**: `251216-001`, `251216-002`, `251217-001`

### λ™μ‘ λ°©μ‹
1. **λ‚ μ§ μ ‘λ‘μ‚¬ μƒμ„±**: ν„μ¬ λ‚ μ§λ¥Ό YYMMDD ν•μ‹μΌλ΅ λ³€ν™
2. **μλ² μ΅°ν**: μ¤λ λ‚ μ§λ΅ μ‹μ‘ν•λ” κ΄€λ¦¬λ²νΈ μ¤‘ κ°€μ¥ ν° μλ² μ΅°ν
3. **μλ² μ¦κ°€**: λ§μ§€λ§‰ μλ² + 1
4. **ν¬λ§·ν…**: μλ²μ„ 3μλ¦¬ λ¬Έμμ—΄λ΅ ν¬λ§·ν… (001, 002, ...)
5. **μ›μμ  μ²λ¦¬**: νΈλμ­μ…μ„ μ‚¬μ©ν•μ—¬ λ™μ‹ λ“±λ΅μ—λ„ μ¤‘λ³µ λ°©μ§€

### λ™μ‹ λ“±λ΅ μ²λ¦¬
- SQLite νΈλμ­μ…μ„ μ‚¬μ©ν•μ—¬ μ›μμ  μ¦κ°€ λ³΄μ¥
- μ—¬λ¬ μ”μ²­μ΄ λ™μ‹μ— λ“¤μ–΄μ™€λ„ μ¤‘λ³µ κ΄€λ¦¬λ²νΈκ°€ μƒμ„±λμ§€ μ•μ

## π”’ DB μ¤ν‚¤λ§ λ³€κ²½

### μ»¬λΌ μ¶”κ°€
- **μ»¬λΌλ…**: `management_id`
- **νƒ€μ…**: `TEXT`
- **NULL ν—μ©**: μ (κΈ°μ΅΄ λ°μ΄ν„° νΈν™μ„±)

### μΈλ±μ¤ μ¶”κ°€
- **μΈλ±μ¤λ…**: `idx_videos_management_id`
- **νƒ€μ…**: UNIQUE
- **μ΅°κ±΄**: `WHERE management_id IS NOT NULL` (NULL κ°’μ€ μΈλ±μ¤μ—μ„ μ μ™Έ)

## β… μ™„λ£ κΈ°μ¤€ λ‹¬μ„±

- [x] κ΄€λ¦¬λ²νΈ ν¬λ§·: YYMMDD-001 κµ¬ν„
- [x] λ™μΌ λ‚ μ§ λ‚΄μ—μ„ μλ²μ΄ 001λ¶€ν„° 1μ”© μ¦κ°€
- [x] λ™μ‹ λ“±λ΅μ—λ„ μ¤‘λ³µμ΄ λ°μƒν•μ§€ μ•λ„λ΅ μ›μμ  μ²λ¦¬ (νΈλμ­μ… μ‚¬μ©)
- [x] video μƒμ„± μ‹μ μ— κ΄€λ¦¬λ²νΈκ°€ μ—†μΌλ©΄ μλ™ μƒμ„±ν•΄μ„ μ €μ¥
- [x] DB ν•„λ“ μ¶”κ°€ (`management_id`) λ° unique μΈλ±μ¤ μ μ©
- [x] λ¨λ“  video μƒμ„± μ—”λ“ν¬μΈνΈμ— λ°μ
- [x] ν”„λ΅ νΈκ°€ λ°›μ„ μ‘λ‹µμ— κ΄€λ¦¬λ²νΈ ν•„λ“ ν¬ν•¨ (μ΄λ―Έ κµ¬ν„λ¨)

## π“ μμ •λ νμΌ λ©λ΅

### 1. db.js
- `generateManagementNo()` ν•¨μ μ¶”κ°€
- `initDB()` ν•¨μμ— `management_id` μ»¬λΌ λ° μΈλ±μ¤ μ¶”κ°€ λ΅μ§

### 2. server.js
- `generateManagementNo` import μ¶”κ°€
- **POST /admin/videos** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€
- **POST /videos/bulk** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€
- **POST /videos/batch** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€
- **POST /videos** - κ΄€λ¦¬λ²νΈ μλ™ μƒμ„± μ¶”κ°€

## π§ ν…μ¤νΈ λ°©λ²•

### 1. μμƒ μƒμ„± ν…μ¤νΈ

```bash
# POST /admin/videos
curl -X POST "http://localhost:8787/admin/videos" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "youtube",
    "source_url": "https://www.youtube.com/watch?v=...",
    "title": "Test Video"
  }'

# μ‘λ‹µμ—μ„ management_id ν™•μΈ:
# {
#   "id": "...",
#   "management_id": "251216-001",
#   ...
# }
```

### 2. λ™μΌ λ‚ μ§ λ‚΄ μλ² μ¦κ°€ ν…μ¤νΈ

```bash
# μ—¬λ¬ μμƒμ„ μ—°μ†μΌλ΅ μƒμ„±ν•λ©΄ μλ²μ΄ μ¦κ°€ν•¨
# μ²« λ²μ§Έ: 251216-001
# λ‘ λ²μ§Έ: 251216-002
# μ„Έ λ²μ§Έ: 251216-003
```

### 3. λ‚ μ§ λ³€κ²½ ν…μ¤νΈ

```bash
# λ‹¤μ λ‚  μμƒ μƒμ„± μ‹ μλ²μ΄ 001λ¶€ν„° λ‹¤μ‹ μ‹μ‘
# 2025-12-16: 251216-001, 251216-002, ...
# 2025-12-17: 251217-001, 251217-002, ...
```

### 4. DB ν™•μΈ

```sql
-- κ΄€λ¦¬λ²νΈ ν™•μΈ
SELECT id, management_id, created_at FROM videos ORDER BY created_at DESC LIMIT 10;

-- unique μΈλ±μ¤ ν™•μΈ
SELECT name FROM sqlite_master WHERE type='index' AND name='idx_videos_management_id';
```

## π”’ λ³΄μ• λ° μ„¤κ³„

### μ›μμ  μ²λ¦¬
- SQLite νΈλμ­μ…μ„ μ‚¬μ©ν•μ—¬ λ™μ‹ λ“±λ΅μ—λ„ μ¤‘λ³µ λ°©μ§€
- μ—¬λ¬ μ”μ²­μ΄ λ™μ‹μ— λ“¤μ–΄μ™€λ„ μλ²μ΄ μ •ν™•ν•κ² μ¦κ°€

### NULL μ²λ¦¬
- κ΄€λ¦¬λ²νΈ μƒμ„± μ‹¤ν¨ μ‹ NULLλ΅ μ €μ¥ (μμƒ μƒμ„±μ€ κ³„μ† μ§„ν–‰)
- unique μΈλ±μ¤λ” NULL κ°’μ„ μ μ™Έν•λ―€λ΅ NULL μ¤‘λ³µ ν—μ©

### κΈ°μ΅΄ λ°μ΄ν„° νΈν™μ„±
- κΈ°μ΅΄ μμƒμ `management_id`λ” NULLλ΅ μ μ§€
- μƒλ΅ μƒμ„±λλ” μμƒλ§ κ΄€λ¦¬λ²νΈ μλ™ μƒμ„±

## π“ μ£Όμμ‚¬ν•­

1. **λ‚ μ§ λ³€κ²½**: λ‚ μ§κ°€ λ³€κ²½λλ©΄ μλ²μ΄ 001λ¶€ν„° λ‹¤μ‹ μ‹μ‘λ©λ‹λ‹¤.

2. **μλ² ν•κ³„**: ν•λ£¨μ— 999κ° μ΄μƒμ μμƒμ„ μƒμ„±ν•λ©΄ μλ²μ΄ 4μλ¦¬λ΅ λ„μ–΄κ° μ μμµλ‹λ‹¤. ν•„μ”μ‹ λ΅μ§ μμ •μ΄ ν•„μ”ν•©λ‹λ‹¤.

3. **κΈ°μ΅΄ λ°μ΄ν„°**: κΈ°μ΅΄ μμƒμ `management_id`λ” NULLλ΅ μ μ§€λ©λ‹λ‹¤. ν•„μ”μ‹ λ§μ΄κ·Έλ μ΄μ… μ¤ν¬λ¦½νΈλ¥Ό μ‘μ„±ν•μ—¬ κΈ°μ΅΄ μμƒμ—λ„ κ΄€λ¦¬λ²νΈλ¥Ό λ¶€μ—¬ν•  μ μμµλ‹λ‹¤.

4. **νΈλμ­μ…**: SQLiteμ νΈλμ­μ…μ„ μ‚¬μ©ν•μ—¬ μ›μμ„±μ„ λ³΄μ¥ν•μ§€λ§, λ§¤μ° λ†’μ€ λ™μ‹μ„± ν™κ²½μ—μ„λ” μ¶”κ°€μ μΈ λ½ λ©”μ»¤λ‹μ¦μ΄ ν•„μ”ν•  μ μμµλ‹λ‹¤.

## β… μµμΆ… ν™•μΈ

λ¨λ“  μ”κµ¬μ‚¬ν•­μ΄ μ™„λ£λμ—μΌλ©°, μμƒ μƒμ„± μ‹ κ΄€λ¦¬λ²νΈκ°€ μλ™μΌλ΅ μƒμ„±λμ–΄ DBμ— μ €μ¥λ©λ‹λ‹¤:
- κ΄€λ¦¬λ²νΈ ν¬λ§·: YYMMDD-001
- λ™μΌ λ‚ μ§ λ‚΄μ—μ„ μλ² μ¦κ°€
- λ™μ‹ λ“±λ΅μ—λ„ μ¤‘λ³µ λ°©μ§€ (μ›μμ  μ²λ¦¬)
- λ¨λ“  video μƒμ„± μ—”λ“ν¬μΈνΈμ— λ°μ
- DB ν•„λ“ λ° unique μΈλ±μ¤ μ¶”κ°€
- ν”„λ΅ νΈ μ‘λ‹µμ— κ΄€λ¦¬λ²νΈ ν•„λ“ ν¬ν•¨

































