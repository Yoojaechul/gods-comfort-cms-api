# CMS API ì•ˆì •í™” ì‘ì—… ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“‚ DB êµ¬ì¡° í™•ì¸ ê²°ê³¼

### ì™¸ë˜í‚¤ êµ¬ì¡° (PRAGMA foreign_key_list)
- `videos.owner_id` -> `users.id`
- `videos.site_id` -> `sites.id`

### sites í…Œì´ë¸”
- `id: "gods"` (ë¬¸ìì—´) - ì¡´ì¬í•¨

### users í…Œì´ë¸”
- Admin: `69a9aab145d4d266274eea65477c0218`, `d2d2efd9bca924d333461f0dc803fa7a`
- Creator: `8572ee8892a0671080817b48610690d0`, `2cd56d79d3cb4407f5a07827fd4ec0b2`

## âœ… ìˆ˜ì •í•œ ë¼ìš°íŠ¸ ë° ë³€ê²½ ì‚¬í•­

### 1. POST /admin/videos (1543ì¤„)
**ë³€ê²½ ë‚´ìš©**:
- `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ (í”„ë¡ íŠ¸ì—”ë“œê°€ ë³´ë‚¸ ê°’ ë¬´ì‹œ)
- `owner_id` ê²€ì¦ ê°•í™”: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©

### 2. POST /videos/bulk (1899ì¤„)
**ë³€ê²½ ë‚´ìš©**:
- `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- `owner_id` ê²€ì¦ ê°•í™”: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©

### 3. POST /videos/batch (2073ì¤„)
**ë³€ê²½ ë‚´ìš©**:
- `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- `owner_id` ê²€ì¦ ê°•í™”: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©

### 4. POST /videos (2239ì¤„)
**ë³€ê²½ ë‚´ìš©**:
- `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- `owner_id` ê²€ì¦ ê°•í™”: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©

### 5. PUT /admin/creators/:id (1159ì¤„)
**ë³€ê²½ ë‚´ìš©**:
- `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ (site_domain/site_url ë¬´ì‹œ)
- Creatorì˜ site_idë¥¼ "gods"ë¡œ ê°•ì œ ì—…ë°ì´íŠ¸

## ğŸ”’ FK ì˜¤ë¥˜ ë°©ì§€ ë¡œì§

### site_id ê°•ì œ ì ìš©
```javascript
// ğŸ”’ site_idëŠ” ë¬´ì¡°ê±´ "gods"ë¡œ ê°•ì œ (ë‹¨ì¼ ì‚¬ì´íŠ¸ ìš´ì˜)
const siteId = "gods";

// "gods" ì‚¬ì´íŠ¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ì—†ìœ¼ë©´ ìƒì„±)
const defaultSite = db.prepare("SELECT * FROM sites WHERE id = ?").get(siteId);
if (!defaultSite) {
  // ìë™ ìƒì„± ë¡œì§
}

// í”„ë¡ íŠ¸ì—”ë“œê°€ ë‹¤ë¥¸ site_idë¥¼ ë³´ëƒˆìœ¼ë©´ ê²½ê³  ë¡œê·¸ë§Œ ì¶œë ¥
if (site_id != null && String(site_id) !== "gods") {
  console.warn(`âš ï¸  ì œê³µëœ site_id(${site_id})ë¥¼ ë¬´ì‹œí•˜ê³  "gods"ë¡œ ê°•ì œ ì ìš©`);
}
```

### owner_id ê²€ì¦ ë° ìë™ ë³µêµ¬
```javascript
// ğŸ”’ owner_id ê²€ì¦ ë° ìë™ ë³µêµ¬
let targetOwnerId = user.id;
const ownerCheck = db.prepare("SELECT * FROM users WHERE id = ?").get(targetOwnerId);
if (!ownerCheck) {
  console.warn(`âš ï¸  owner_id(${targetOwnerId})ê°€ users í…Œì´ë¸”ì— ì—†ì–´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ì‚¬ìš©`);
  // ê°€ì¥ ì˜¤ë˜ëœ admin ë˜ëŠ” creator ì¡°íšŒ
  const defaultOwner = db.prepare("SELECT id FROM users WHERE role IN ('admin', 'creator') ORDER BY created_at ASC LIMIT 1").get();
  if (defaultOwner) {
    targetOwnerId = defaultOwner.id;
    console.log(`   â†’ ê¸°ë³¸ ì‚¬ìš©ìë¡œ ë³€ê²½: ${targetOwnerId}`);
  } else {
    return reply.code(400).send({ 
      error: `Owner ID '${targetOwnerId}' does not exist in users table, and no default user exists`,
      details: "Please ensure at least one user (admin or creator) exists in the users table"
    });
  }
}
```

## ğŸ“ FK ì˜¤ë¥˜ê°€ ë‹¤ì‹œ ë°œìƒí•˜ì§€ ì•ŠëŠ” ì´ìœ 

1. **site_id ê°•ì œ ì ìš©**: ëª¨ë“  ì˜ìƒ ìƒì„±/ìˆ˜ì • APIì—ì„œ `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ì„¤ì •í•˜ë¯€ë¡œ, í”„ë¡ íŠ¸ì—”ë“œê°€ ìˆ«ìë‚˜ ë‹¤ë¥¸ ê°’ì„ ë³´ë‚´ë„ DBì˜ `sites.id`ì™€ í•­ìƒ ì¼ì¹˜í•©ë‹ˆë‹¤.

2. **owner_id ê²€ì¦**: `owner_id`ê°€ `users` í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creatorë¥¼ ìë™ìœ¼ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ FK ì œì•½ì¡°ê±´ì„ í•­ìƒ ë§Œì¡±í•©ë‹ˆë‹¤.

3. **"gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„±**: `sites` í…Œì´ë¸”ì— `"gods"` ì‚¬ì´íŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„±í•˜ë¯€ë¡œ, `videos.site_id`ê°€ í•­ìƒ ìœ íš¨í•œ ê°’ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.

4. **DB êµ¬ì¡° ë³€ê²½ ì—†ìŒ**: ê¸°ì¡´ DB êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ, ì„œë²„ ë¡œì§ë§Œ ìˆ˜ì •í•˜ì—¬ FK ì œì•½ì¡°ê±´ì„ ë³´ì¥í•©ë‹ˆë‹¤.

## âœ… ìµœì¢… í™•ì¸ ì‚¬í•­

- [x] DB êµ¬ì¡° í™•ì¸ (PRAGMA foreign_key_list, sites, users)
- [x] ëª¨ë“  ì˜ìƒ ìƒì„± ì—”ë“œí¬ì¸íŠ¸ì—ì„œ site_idë¥¼ "gods"ë¡œ ê°•ì œ
- [x] ëª¨ë“  ì˜ìƒ ìƒì„± ì—”ë“œí¬ì¸íŠ¸ì—ì„œ owner_id ê²€ì¦ ë° ìë™ ë³µêµ¬
- [x] PUT /admin/creators/:idì—ì„œ site_idë¥¼ "gods"ë¡œ ê°•ì œ
- [x] DB êµ¬ì¡° ë³€ê²½ ì—†ìŒ (ê¸°ì¡´ cms.db ìœ ì§€)

FOREIGN KEY constraint failed ì˜¤ë¥˜ê°€ ë” ì´ìƒ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.



































