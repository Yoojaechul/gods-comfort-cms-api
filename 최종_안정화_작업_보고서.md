# CMS API ì•ˆì •í™” ì‘ì—… ìµœì¢… ë³´ê³ ì„œ

## âœ… ìˆ˜ì • ì™„ë£Œëœ ë¼ìš°íŠ¸

### 1. POST /admin/videos (1543ì¤„)
- âœ… `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- âœ… `owner_id` ê²€ì¦: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©
- âœ… "gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„± ë¡œì§ í¬í•¨

### 2. POST /videos/bulk (1899ì¤„)
- âœ… `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- âœ… `owner_id` ê²€ì¦: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©
- âœ… "gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„± ë¡œì§ í¬í•¨

### 3. POST /videos/batch (2073ì¤„)
- âœ… `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- âœ… `owner_id` ê²€ì¦: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©
- âœ… "gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„± ë¡œì§ í¬í•¨

### 4. POST /videos (2239ì¤„)
- âœ… `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- âœ… `owner_id` ê²€ì¦: users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©
- âœ… "gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„± ë¡œì§ í¬í•¨

### 5. PUT /videos/:id (2449ì¤„)
- âœ… ì˜ìƒ ìˆ˜ì • ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬ í™•ì¸
- âœ… site_id/owner_id ë³€ê²½ ë¡œì§ ì—†ìŒ (ê¸°ì¡´ ê°’ ìœ ì§€)
- âœ… FK ë¬¸ì œ ì—†ìŒ (ê¸°ì¡´ ì˜ìƒì˜ site_id/owner_idëŠ” ì´ë¯¸ ìœ íš¨)

### 6. PUT /admin/creators/:id (1159ì¤„)
- âœ… `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ
- âœ… site_domain/site_url ë¬´ì‹œí•˜ê³  "gods"ë¡œ ê°•ì œ ì—…ë°ì´íŠ¸

### 7. PATCH /admin/videos/:id (1699ì¤„)
- âœ… ì˜ìƒ ìˆ˜ì • ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬ í™•ì¸
- âœ… site_id/owner_id ë³€ê²½ ë¡œì§ ì—†ìŒ (ê¸°ì¡´ ê°’ ìœ ì§€)
- âœ… FK ë¬¸ì œ ì—†ìŒ

## ğŸ”’ FK ì˜¤ë¥˜ ë°©ì§€ ë©”ì»¤ë‹ˆì¦˜

### 1. site_id ê°•ì œ ì ìš©
```javascript
// ğŸ”’ site_idëŠ” ë¬´ì¡°ê±´ "gods"ë¡œ ê°•ì œ (ë‹¨ì¼ ì‚¬ì´íŠ¸ ìš´ì˜)
const siteId = "gods";

// "gods" ì‚¬ì´íŠ¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ì—†ìœ¼ë©´ ìƒì„±)
const defaultSite = db.prepare("SELECT * FROM sites WHERE id = ?").get(siteId);
if (!defaultSite) {
  // ìë™ ìƒì„± ë¡œì§
}

// í”„ë¡ íŠ¸ì—”ë“œê°€ ë‹¤ë¥¸ site_idë¥¼ ë³´ëƒˆìœ¼ë©´ ê²½ê³  ë¡œê·¸ë§Œ ì¶œë ¥
if (site_id != null && String(site_id) !== "gods") {
  console.warn(`âš ï¸  ì œê³µëœ site_id(${site_id})ë¥¼ ë¬´ì‹œí•˜ê³  "gods"ë¡œ ê°•ì œ ì ìš©`);
}
```

**ì ìš© ìœ„ì¹˜**: ëª¨ë“  ì˜ìƒ ìƒì„± ì—”ë“œí¬ì¸íŠ¸ (POST /admin/videos, POST /videos/bulk, POST /videos/batch, POST /videos)

### 2. owner_id ê²€ì¦ ë° ìë™ ë³µêµ¬
```javascript
// ğŸ”’ owner_id ê²€ì¦ ë° ìë™ ë³µêµ¬
let targetOwnerId = user.id;
const ownerCheck = db.prepare("SELECT * FROM users WHERE id = ?").get(targetOwnerId);
if (!ownerCheck) {
  console.warn(`âš ï¸  owner_id(${targetOwnerId})ê°€ users í…Œì´ë¸”ì— ì—†ì–´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ì‚¬ìš©`);
  // ê°€ì¥ ì˜¤ë˜ëœ admin ë˜ëŠ” creator ì¡°íšŒ
  const defaultOwner = db.prepare("SELECT id FROM users WHERE role IN ('admin', 'creator') ORDER BY created_at ASC LIMIT 1").get();
  if (defaultOwner) {
    targetOwnerId = defaultOwner.id;
    console.log(`   â†’ ê¸°ë³¸ ì‚¬ìš©ìë¡œ ë³€ê²½: ${targetOwnerId}`);
  } else {
    return reply.code(400).send({ 
      error: `Owner ID '${targetOwnerId}' does not exist in users table, and no default user exists`,
      details: "Please ensure at least one user (admin or creator) exists in the users table"
    });
  }
}
```

**ì ìš© ìœ„ì¹˜**: ëª¨ë“  ì˜ìƒ ìƒì„± ì—”ë“œí¬ì¸íŠ¸

### 3. "gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„±
- sites í…Œì´ë¸”ì— "gods" ì‚¬ì´íŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
- FK ì œì•½ì¡°ê±´ì„ í•­ìƒ ë§Œì¡±í•˜ë„ë¡ ë³´ì¥

## ğŸ“ FK ì˜¤ë¥˜ê°€ ë‹¤ì‹œ ë°œìƒí•˜ì§€ ì•ŠëŠ” ì´ìœ 

### 1. site_id ê°•ì œ ì ìš©
- **ë¬¸ì œ**: í”„ë¡ íŠ¸ì—”ë“œê°€ ìˆ«ì `site_id` (ì˜ˆ: `1765684445`)ë¥¼ ë³´ëƒ„
- **í•´ê²°**: ëª¨ë“  ì˜ìƒ ìƒì„± APIì—ì„œ `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ì„¤ì •
- **ê²°ê³¼**: DBì˜ `sites.id` (ë¬¸ìì—´ `"gods"`)ì™€ í•­ìƒ ì¼ì¹˜

### 2. owner_id ê²€ì¦
- **ë¬¸ì œ**: `owner_id`ê°€ `users` í…Œì´ë¸”ì— ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
- **í•´ê²°**: `owner_id`ê°€ `users` í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ìë™ ì‚¬ìš©
- **ê²°ê³¼**: FK ì œì•½ì¡°ê±´ì„ í•­ìƒ ë§Œì¡±

### 3. "gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„±
- **ë¬¸ì œ**: `sites` í…Œì´ë¸”ì— "gods" ì‚¬ì´íŠ¸ê°€ ì—†ì„ ìˆ˜ ìˆìŒ
- **í•´ê²°**: "gods" ì‚¬ì´íŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
- **ê²°ê³¼**: `videos.site_id`ê°€ í•­ìƒ ìœ íš¨í•œ ê°’ì„ ì°¸ì¡°

### 4. DB êµ¬ì¡° ë³€ê²½ ì—†ìŒ
- ê¸°ì¡´ `cms.db` êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€
- ì„œë²„ ë¡œì§ë§Œ ìˆ˜ì •í•˜ì—¬ FK ì œì•½ì¡°ê±´ ë³´ì¥
- ê¸°ì¡´ ë°ì´í„° ìµœëŒ€í•œ ì¡´ì¤‘

## âœ… ìµœì¢… í™•ì¸ ì‚¬í•­

- [x] DB êµ¬ì¡° í™•ì¸ (PRAGMA foreign_key_list, sites, users)
- [x] POST /admin/videos - site_id "gods" ê°•ì œ, owner_id ê²€ì¦
- [x] POST /videos/bulk - site_id "gods" ê°•ì œ, owner_id ê²€ì¦
- [x] POST /videos/batch - site_id "gods" ê°•ì œ, owner_id ê²€ì¦
- [x] POST /videos - site_id "gods" ê°•ì œ, owner_id ê²€ì¦
- [x] PUT /videos/:id - ì¡´ì¬ í™•ì¸ (site_id/owner_id ë³€ê²½ ì—†ìŒ)
- [x] PUT /admin/creators/:id - site_id "gods" ê°•ì œ
- [x] PATCH /admin/videos/:id - ì¡´ì¬ í™•ì¸ (site_id/owner_id ë³€ê²½ ì—†ìŒ)
- [x] DB êµ¬ì¡° ë³€ê²½ ì—†ìŒ (ê¸°ì¡´ cms.db ìœ ì§€)

## ğŸ“Š ìš”ì•½

**ìˆ˜ì •í•œ ë¼ìš°íŠ¸**: 6ê°œ
- POST /admin/videos
- POST /videos/bulk
- POST /videos/batch
- POST /videos
- PUT /admin/creators/:id
- PUT /videos/:id (í™•ì¸ ì™„ë£Œ)

**FK ì˜¤ë¥˜ ë°©ì§€ ë°©ë²•**:
1. `site_id`ë¥¼ ë¬´ì¡°ê±´ `"gods"`ë¡œ ê°•ì œ (í”„ë¡ íŠ¸ì—”ë“œ ê°’ ë¬´ì‹œ)
2. `owner_id` ê²€ì¦ ë° ìë™ ë³µêµ¬ (users í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ admin/creator ì‚¬ìš©)
3. "gods" ì‚¬ì´íŠ¸ ìë™ ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±)

**ê²°ê³¼**: FOREIGN KEY constraint failed ì˜¤ë¥˜ê°€ ë” ì´ìƒ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.








































