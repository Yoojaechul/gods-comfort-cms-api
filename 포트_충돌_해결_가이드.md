# Windows 포트 충돌 해결 가이드

## 🔧 EADDRINUSE 오류 해결 단계

### 1단계: 포트 점유 프로세스 확인
```powershell
netstat -ano | findstr :8787
```

**출력 예시:**
```
TCP    0.0.0.0:8787           0.0.0.0:0              LISTENING       10008
```
→ 마지막 숫자(10008)가 PID입니다.

### 2단계: 프로세스 강제 종료
```powershell
taskkill /PID 10008 /F
```

**성공 메시지:**
```
성공: 프로세스(PID 10008)가 종료되었습니다.
```

### 3단계: 포트 해제 확인
```powershell
netstat -ano | findstr :8787
```
→ 출력이 없으면 포트가 해제된 것입니다.

### 4단계: 서버 재실행
```powershell
cd "c:\Users\consu_rutwdcg\SynologyDrive\999. cms_api"
npm run dev
```

## 🔄 대체 방법: 모든 Node.js 프로세스 종료 (선택)

포트를 점유한 프로세스를 찾기 어려운 경우:

```powershell
# 모든 node.exe 프로세스 종료
taskkill /IM node.exe /F
```

**주의**: 이 명령은 실행 중인 모든 Node.js 프로세스를 종료합니다.

## ✅ 개선 사항

### 자동 대체 포트 기능 추가

`server.js`에 다음 기능이 추가되었습니다:

1. **환경변수 우선 사용**: `process.env.PORT`가 설정되어 있으면 사용
2. **기본 포트**: 환경변수가 없으면 `8787` 사용
3. **자동 대체 포트**: 포트가 사용 중이면 자동으로 다음 포트(8788, 8789...) 시도
4. **최대 시도 횟수**: 10개 포트까지 자동 시도

**코드:**
```javascript
const DEFAULT_PORT = parseInt(process.env.PORT) || 8787;
const MAX_PORT_ATTEMPTS = 10;

async function startServer(port, attempt = 1) {
  try {
    await app.listen({ port, host: "0.0.0.0" });
    console.log(`✅ CMS API Server running on http://0.0.0.0:${port}`);
    return port;
  } catch (err) {
    if (err.code === "EADDRINUSE" && attempt < MAX_PORT_ATTEMPTS) {
      const nextPort = port + 1;
      console.warn(`⚠️  Port ${port} is already in use. Trying port ${nextPort}...`);
      return startServer(nextPort, attempt + 1);
    } else {
      app.log.error(err);
      process.exit(1);
    }
  }
}
```

## 📋 PORT 설정 확인

### 현재 설정
- **환경변수 우선**: `process.env.PORT` 사용
- **기본값**: `8787`
- **대체 포트**: 자동으로 8788, 8789... 시도

### .env 파일 설정 (선택)
`.env` 파일에 다음을 추가하여 포트를 고정할 수 있습니다:
```
PORT=8787
```

또는 다른 포트를 사용하려면:
```
PORT=8788
```

## 🧪 테스트

### 서버 실행 확인
```powershell
npm run dev
```

**정상 실행 시 출력:**
```
✅ SQLite database opened successfully
✅ Found 11 tables in database
✅ CMS API Server running on http://0.0.0.0:8787
📊 Admin UI: http://localhost:8787/admin
🎨 Creator UI: http://localhost:8787/creator
```

### Health Check
```powershell
Invoke-WebRequest -Uri "http://localhost:8787/health" -Method GET -UseBasicParsing
```

**예상 응답:**
```
StatusCode: 200
Content: {"ok":true,"time":"2025-12-14T02:05:21.204Z"}
```

## 📝 참고사항

1. **포트 충돌 시 자동 처리**: 이제 서버가 자동으로 다음 포트를 시도합니다.
2. **환경변수 우선**: `.env` 파일의 `PORT` 값이 우선 적용됩니다.
3. **프로세스 확인**: `netstat -ano | findstr :8787`로 항상 포트 상태를 확인할 수 있습니다.

## 🔍 문제 해결

### 여전히 포트 충돌이 발생하는 경우

1. **다른 터미널에서 실행 중인 서버 확인**
   ```powershell
   netstat -ano | findstr :8787
   ```

2. **모든 Node.js 프로세스 확인**
   ```powershell
   tasklist | findstr node.exe
   ```

3. **강제 종료 후 재시작**
   ```powershell
   taskkill /IM node.exe /F
   npm run dev
   ```

### 대체 포트가 사용된 경우

서버가 8788, 8789 등의 포트를 사용한 경우:
- 로그에서 실제 사용 중인 포트 확인
- Next.js의 `NEXT_PUBLIC_API_BASE_URL` 환경변수를 해당 포트로 업데이트


























