# ëŒ€ëŸ‰ ë“±ë¡ ì •ë ¬ ê·œì¹™ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. DB ìŠ¤í‚¤ë§ˆ í™•ì¥
- âœ… **videos í…Œì´ë¸”ì— ëŒ€ëŸ‰ ë“±ë¡ ê´€ë ¨ í•„ë“œ ì¶”ê°€**
  - `batch_id TEXT`: ëŒ€ëŸ‰ ë“±ë¡ ë¬¶ìŒ ID
  - `batch_order INTEGER`: ë¬¶ìŒ ì•ˆ ìˆœì„œ (1, 2, 3...)
  - `batch_created_at TEXT`: ë¬¶ìŒ ìƒì„± ì‹œê°„ (ISO 8601 í˜•ì‹)
  - ì¸ë±ìŠ¤ ì¶”ê°€: `batch_created_at DESC`, `batch_order ASC` (ì •ë ¬ ì„±ëŠ¥ í–¥ìƒ)

### 2. ëŒ€ëŸ‰ ë“±ë¡ API ìˆ˜ì •
- âœ… **POST /videos/bulk** (Admin/Creator ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥)
  - ìš”ì²­ìœ¼ë¡œ ë“¤ì–´ì˜¨ ë°°ì—´ ìˆœì„œëŒ€ë¡œ `batchOrder = index + 1` ì €ì¥
  - ê°™ì€ ìš”ì²­ì— í¬í•¨ëœ ëª¨ë“  ì˜ìƒì€ ë™ì¼í•œ `batchId`ì™€ `batchCreatedAt` ì‚¬ìš©
- âœ… **POST /videos/batch** (Creator ì „ìš©)
  - ë™ì¼í•œ ë¡œì§ ì ìš©

### 3. ëª©ë¡ ì¡°íšŒ API ì •ë ¬ ìˆ˜ì •
- âœ… **GET /public/videos**: ëŒ€ëŸ‰ ë“±ë¡ ìš°ì„  ì •ë ¬ ì ìš©
- âœ… **GET /admin/videos**: ëŒ€ëŸ‰ ë“±ë¡ ìš°ì„  ì •ë ¬ ì ìš©
- âœ… **GET /videos** (Creatorìš©): ëŒ€ëŸ‰ ë“±ë¡ ìš°ì„  ì •ë ¬ ì ìš©

### 4. ì‘ë‹µ DTOì— í•„ë“œ í¬í•¨
- âœ… ëª¨ë“  ëª©ë¡ ì¡°íšŒ API ì‘ë‹µì— `batchId`, `batchOrder`, `batchCreatedAt` í•„ë“œ í¬í•¨

## ğŸ”’ ì ìš©ëœ ìˆ˜ì • ì‚¬í•­

### DB ìŠ¤í‚¤ë§ˆ (db.js)

```javascript
// videos í…Œì´ë¸”ì— ëŒ€ëŸ‰ ë“±ë¡ ê´€ë ¨ ì»¬ëŸ¼ ì¶”ê°€
const batchColumns = [
  { name: "batch_id", type: "TEXT" },
  { name: "batch_order", type: "INTEGER" },
  { name: "batch_created_at", type: "TEXT" },
];

for (const column of batchColumns) {
  if (!videosColumns.includes(column.name)) {
    db.exec(`ALTER TABLE videos ADD COLUMN ${column.name} ${column.type}`);
  }
}

// ì¸ë±ìŠ¤ ì¶”ê°€ (ì •ë ¬ ì„±ëŠ¥ í–¥ìƒ)
db.exec("CREATE INDEX IF NOT EXISTS idx_videos_batch_created_at ON videos(batch_created_at DESC) WHERE batch_created_at IS NOT NULL");
db.exec("CREATE INDEX IF NOT EXISTS idx_videos_batch_order ON videos(batch_order ASC) WHERE batch_order IS NOT NULL");
```

### ëŒ€ëŸ‰ ë“±ë¡ API (POST /videos/bulk, POST /videos/batch)

```javascript
// ëŒ€ëŸ‰ ë“±ë¡ ë¬¶ìŒ ì •ë³´ ìƒì„±
const batchId = generateId();
const batchCreatedAt = new Date().toISOString();
console.log(`[${routeName}] ëŒ€ëŸ‰ ë“±ë¡ ë¬¶ìŒ ìƒì„±: batchId=${batchId}, batchCreatedAt=${batchCreatedAt}, ì˜ìƒ ê°œìˆ˜=${videosToAdd.length}`);

for (let index = 0; index < videosToAdd.length; index++) {
  const videoData = videosToAdd[index];
  // ...
  const batchOrder = index + 1; // ì²« ë²ˆì§¸ ì˜ìƒì´ 1
  
  db.prepare(
    "INSERT INTO videos (..., batch_id, batch_order, batch_created_at) VALUES (..., ?, ?, ?)"
  ).run(
    // ... ê¸°ì¡´ í•„ë“œë“¤
    batchId,        // ëŒ€ëŸ‰ ë“±ë¡ ë¬¶ìŒ ID
    batchOrder,     // ë¬¶ìŒ ì•ˆ ìˆœì„œ (1, 2, 3...)
    batchCreatedAt // ë¬¶ìŒ ìƒì„± ì‹œê°„
  );
}
```

### ëª©ë¡ ì¡°íšŒ API ì •ë ¬ (GET /public/videos, GET /admin/videos, GET /videos)

**ì´ì „ ì •ë ¬**:
```sql
ORDER BY v.created_at DESC, v.management_id DESC
```

**ìˆ˜ì •ëœ ì •ë ¬**:
```sql
ORDER BY 
  COALESCE(v.batch_created_at, v.created_at) DESC,  -- 1ìˆœìœ„: ëŒ€ëŸ‰ ë“±ë¡ ë¬¶ìŒ ìƒì„± ì‹œê°„ (ì—†ìœ¼ë©´ created_at)
  COALESCE(v.batch_order, 999999) ASC,              -- 2ìˆœìœ„: ë¬¶ìŒ ì•ˆ ìˆœì„œ (ì—†ìœ¼ë©´ í° ê°’ìœ¼ë¡œ fallback)
  v.management_id DESC,                             -- 3ìˆœìœ„: ê´€ë¦¬ë²ˆí˜¸
  v.created_at DESC                                 -- 4ìˆœìœ„: ìƒì„± ì‹œê°„ (fallback)
```

### ì‘ë‹µ DTO í•„ë“œ ì¶”ê°€

```javascript
const enhancedVideos = videos.map((video) => {
  return {
    ...video,
    // ê¸°ì¡´ í•„ë“œë“¤...
    // ëŒ€ëŸ‰ ë“±ë¡ ê´€ë ¨ í•„ë“œ ì¶”ê°€
    batchId: video.batch_id || null,
    batchOrder: video.batch_order || null,
    batchCreatedAt: video.batch_created_at || null,
  };
});
```

## ğŸ“ ì •ë ¬ ë¡œì§ ìƒì„¸

### ì •ë ¬ ìš°ì„ ìˆœìœ„

1. **`batch_created_at DESC`** (ë˜ëŠ” `created_at DESC` fallback)
   - ëŒ€ëŸ‰ ë“±ë¡ ë¬¶ìŒ ìƒì„± ì‹œê°„ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
   - ì—†ìœ¼ë©´ `created_at` ì‚¬ìš©
   - ìµœì‹  ë¬¶ìŒì´ ë¨¼ì € ì˜¤ë„ë¡ ë³´ì¥

2. **`batch_order ASC`** (ë˜ëŠ” `999999` fallback)
   - ê°™ì€ ë¬¶ìŒ ë‚´ì—ì„œ ìˆœì„œ ì •ë ¬
   - ì²« ë²ˆì§¸ ì˜ìƒ(`batch_order = 1`)ì´ ë¨¼ì € ì˜´
   - ëŒ€ëŸ‰ ë“±ë¡ì´ ì•„ë‹Œ ì˜ìƒì€ `999999`ë¡œ ì²˜ë¦¬í•˜ì—¬ ë’¤ë¡œ ë°€ë¦¼

3. **`management_id DESC`** (ë³´ì¡° ì •ë ¬)
   - ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ ì˜ìƒì´ ìˆì„ ë•Œ ê´€ë¦¬ë²ˆí˜¸ë¡œ ì •ë ¬

4. **`created_at DESC`** (ìµœì¢… fallback)
   - ëª¨ë“  ì •ë ¬ ê¸°ì¤€ì´ ì—†ì„ ë•Œ ì‚¬ìš©

### ë™ì‘ ì˜ˆì‹œ

**ì‹œë‚˜ë¦¬ì˜¤**: ëŒ€ëŸ‰ ë“±ë¡ìœ¼ë¡œ 3ê°œ ì˜ìƒ ë“±ë¡ (A, B, C ìˆœì„œ)

1. **ëŒ€ëŸ‰ ë“±ë¡ ì‹œ**:
   - ëª¨ë“  ì˜ìƒì— ë™ì¼í•œ `batchId`ì™€ `batchCreatedAt` ì €ì¥
   - A: `batchOrder = 1`
   - B: `batchOrder = 2`
   - C: `batchOrder = 3`

2. **ëª©ë¡ ì¡°íšŒ ì‹œ**:
   - `batch_created_at DESC`ë¡œ ìµœì‹  ë¬¶ìŒì´ ë¨¼ì € ì˜´
   - ê°™ì€ ë¬¶ìŒ ë‚´ì—ì„œëŠ” `batch_order ASC`ë¡œ A â†’ B â†’ C ìˆœì„œ
   - **ê²°ê³¼: Aê°€ ë§¨ ìœ„/ë§¨ ì¢Œì¸¡ì— í‘œì‹œë¨**

3. **ê¸°ì¡´ ì˜ìƒ (ëŒ€ëŸ‰ ë“±ë¡ ì•„ë‹˜)**:
   - `batch_created_at`ì´ NULLì´ë¯€ë¡œ `created_at` ì‚¬ìš©
   - `batch_order`ê°€ NULLì´ë¯€ë¡œ `999999`ë¡œ ì²˜ë¦¬ë˜ì–´ ëŒ€ëŸ‰ ë“±ë¡ ì˜ìƒ ë’¤ë¡œ ë°€ë¦¼

## âœ… ì™„ë£Œ ê¸°ì¤€ ë‹¬ì„±

- [x] Videoì— batchId, batchOrder, batchCreatedAt í•„ë“œ ì¶”ê°€
- [x] ëŒ€ëŸ‰ ë“±ë¡ APIì—ì„œ ë°°ì—´ ìˆœì„œëŒ€ë¡œ batchOrder = index+1 ì €ì¥
- [x] ê°™ì€ ìš”ì²­ì˜ ëª¨ë“  ì˜ìƒì´ ë™ì¼í•œ batchIdì™€ batchCreatedAt ì‚¬ìš©
- [x] ëª©ë¡ ì¡°íšŒ ê¸°ë³¸ ì •ë ¬: batchCreatedAt DESC â†’ batchOrder ASC
- [x] ê¸°ì¡´ ë°ì´í„° fallback ì •ë ¬ ìœ ì§€ (COALESCE ì‚¬ìš©)
- [x] DTO/ì‘ë‹µì— batchId, batchOrder, batchCreatedAt í¬í•¨

## ğŸ“Š ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### 1. db.js
- `initDB()` í•¨ìˆ˜ì— ëŒ€ëŸ‰ ë“±ë¡ ê´€ë ¨ ì»¬ëŸ¼ ì¶”ê°€ ë¡œì§
- ì¸ë±ìŠ¤ ìƒì„± ë¡œì§

### 2. server.js
- **POST /videos/bulk**: batchId, batchOrder, batchCreatedAt ì €ì¥ ë¡œì§ ì¶”ê°€
- **POST /videos/batch**: batchId, batchOrder, batchCreatedAt ì €ì¥ ë¡œì§ ì¶”ê°€
- **GET /public/videos**: ì •ë ¬ ìˆ˜ì • ë° ì‘ë‹µ í•„ë“œ ì¶”ê°€
- **GET /admin/videos**: ì •ë ¬ ìˆ˜ì • ë° ì‘ë‹µ í•„ë“œ ì¶”ê°€
- **GET /videos** (Creatorìš©): ì •ë ¬ ìˆ˜ì • ë° ì‘ë‹µ í•„ë“œ ì¶”ê°€

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ëŒ€ëŸ‰ ë“±ë¡ í…ŒìŠ¤íŠ¸

```bash
# POST /videos/bulk
curl -X POST "http://localhost:8787/videos/bulk" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "videos": [
      { "platform": "youtube", "source_url": "https://youtube.com/watch?v=video1", "title": "ì˜ìƒ A" },
      { "platform": "youtube", "source_url": "https://youtube.com/watch?v=video2", "title": "ì˜ìƒ B" },
      { "platform": "youtube", "source_url": "https://youtube.com/watch?v=video3", "title": "ì˜ìƒ C" }
    ]
  }'

# ì‘ë‹µ í™•ì¸:
# {
#   "success": true,
#   "created": 3,
#   "results": [
#     { "id": "...", "batch_id": "abc123", "batch_order": 1, "batch_created_at": "2025-12-16T10:00:00.000Z", ... },
#     { "id": "...", "batch_id": "abc123", "batch_order": 2, "batch_created_at": "2025-12-16T10:00:00.000Z", ... },
#     { "id": "...", "batch_id": "abc123", "batch_order": 3, "batch_created_at": "2025-12-16T10:00:00.000Z", ... }
#   ]
# }
```

### 2. ëª©ë¡ ì¡°íšŒ ì •ë ¬ í™•ì¸

```bash
# GET /public/videos
curl -X GET "http://localhost:8787/public/videos?site_id=gods&limit=10"

# ì‘ë‹µ í™•ì¸:
# {
#   "items": [
#     {
#       "id": "...",
#       "title": "ì˜ìƒ A",  // ì²« ë²ˆì§¸ ì˜ìƒì´ ë§¨ ìœ„
#       "batchId": "abc123",
#       "batchOrder": 1,
#       "batchCreatedAt": "2025-12-16T10:00:00.000Z",
#       ...
#     },
#     {
#       "id": "...",
#       "title": "ì˜ìƒ B",  // ë‘ ë²ˆì§¸ ì˜ìƒ
#       "batchId": "abc123",
#       "batchOrder": 2,
#       ...
#     },
#     {
#       "id": "...",
#       "title": "ì˜ìƒ C",  // ì„¸ ë²ˆì§¸ ì˜ìƒ
#       "batchId": "abc123",
#       "batchOrder": 3,
#       ...
#     }
#   ]
# }
```

### 3. ê¸°ì¡´ ì˜ìƒê³¼ ëŒ€ëŸ‰ ë“±ë¡ ì˜ìƒ í˜¼í•© í™•ì¸

```bash
# ê¸°ì¡´ ì˜ìƒ(ëŒ€ëŸ‰ ë“±ë¡ ì•„ë‹˜)ê³¼ ëŒ€ëŸ‰ ë“±ë¡ ì˜ìƒì´ ì„ì—¬ ìˆì„ ë•Œ
# ëŒ€ëŸ‰ ë“±ë¡ ì˜ìƒì´ ìµœì‹ ì´ë©´ ë§¨ ìœ„ì—, ê·¸ ì•ˆì—ì„œ ì²« ë²ˆì§¸ ì˜ìƒì´ ë§¨ ìœ„ì— ì˜¤ëŠ”ì§€ í™•ì¸
```

## ğŸ”’ ì •ë ¬ ë³´ì¥

### ì„œë²„ ì¸¡ ì •ë ¬
- SQL `ORDER BY` ì ˆì„ ì‚¬ìš©í•˜ì—¬ DB ë ˆë²¨ì—ì„œ ì •ë ¬
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¶”ê°€ ì •ë ¬ ë¡œì§ì´ í•„ìš” ì—†ìŒ
- í•­ìƒ ì²« ë²ˆì§¸ ì˜ìƒì´ ë§¨ ìœ„/ë§¨ ì¢Œì¸¡ì— ë°˜í™˜ë¨

### ë™ì¼ ë¬¶ìŒ ì²˜ë¦¬
- ê°™ì€ `batchId`ë¥¼ ê°€ì§„ ì˜ìƒë“¤ì€ `batch_order`ë¡œ ì •ë ¬
- ì²« ë²ˆì§¸ ì˜ìƒ(`batch_order = 1`)ì´ í•­ìƒ ë¨¼ì € ì˜´

### ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±
- `COALESCE`ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ ì˜ìƒ(í•„ë“œê°€ NULL)ë„ ì •ìƒì ìœ¼ë¡œ ì •ë ¬ë¨
- ëŒ€ëŸ‰ ë“±ë¡ ì˜ìƒì´ ìµœì‹ ì´ë©´ ë§¨ ìœ„ì—, ê¸°ì¡´ ì˜ìƒì€ ë’¤ë¡œ ë°€ë¦¼

## ğŸ“Œ ì£¼ì˜ì‚¬í•­

1. **ë°°ì—´ ìˆœì„œ**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ëŒ€ëŸ‰ ë“±ë¡ ì‹œ ë°°ì—´ ìˆœì„œê°€ ì¤‘ìš”í•©ë‹ˆë‹¤. ì²« ë²ˆì§¸ ì˜ìƒì´ `batchOrder = 1`ì´ ë©ë‹ˆë‹¤.

2. **ì‹œê°„ ë™ê¸°í™”**: ê°™ì€ ìš”ì²­ ë‚´ì˜ ëª¨ë“  ì˜ìƒì€ ë™ì¼í•œ `batchCreatedAt`ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ë¬¶ìŒ ë‹¨ìœ„ë¡œ ì •ë ¬ë©ë‹ˆë‹¤.

3. **ì¸ë±ìŠ¤**: `batch_created_at`ê³¼ `batch_order`ì— ì¸ë±ìŠ¤ê°€ ì¶”ê°€ë˜ì–´ ì •ë ¬ ì„±ëŠ¥ì´ í–¥ìƒë©ë‹ˆë‹¤.

4. **NULL ì²˜ë¦¬**: ê¸°ì¡´ ì˜ìƒì€ `batch_id`, `batch_order`, `batch_created_at`ì´ NULLì´ì§€ë§Œ, `COALESCE`ë¡œ ì •ìƒì ìœ¼ë¡œ ì •ë ¬ë©ë‹ˆë‹¤.

## âœ… ìµœì¢… í™•ì¸

ëª¨ë“  ìš”êµ¬ì‚¬í•­ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©°, ëŒ€ëŸ‰ ë“±ë¡ ì‹œ ì²« ë²ˆì§¸ ì˜ìƒì´ ìµœì‹  ì˜ìƒì²˜ëŸ¼ ë§¨ ìœ„/ë§¨ ì¢Œì¸¡ì— í‘œì‹œë©ë‹ˆë‹¤:
- DB ìŠ¤í‚¤ë§ˆì— batchId, batchOrder, batchCreatedAt í•„ë“œ ì¶”ê°€
- ëŒ€ëŸ‰ ë“±ë¡ APIì—ì„œ ë°°ì—´ ìˆœì„œëŒ€ë¡œ batchOrder ì €ì¥
- ëª©ë¡ ì¡°íšŒ API ì •ë ¬ ê·œì¹™ ì ìš© (batchCreatedAt DESC â†’ batchOrder ASC)
- ì‘ë‹µì— batchId, batchOrder, batchCreatedAt í•„ë“œ í¬í•¨
- ê¸°ì¡´ ë°ì´í„° fallback ì •ë ¬ ìœ ì§€

















