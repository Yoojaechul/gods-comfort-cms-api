# 단일 홈페이지 최적화 완료

## ✅ 수정된 파일 및 코드 Diff

### 1. `server.js` - Settings API 엔드포인트 추가 및 단일 홈페이지 최적화

**변경 사항**:
1. `PUT /sites/:id` - 사이트 수정 엔드포인트 추가 (Settings 저장용)
2. `PUT /admin/sites/:id` - Admin 사이트 수정 엔드포인트 추가
3. `POST /sites` - 단일 홈페이지 최적화: 기본 사이트("gods") 생성 또는 업데이트
4. `POST /admin/sites` - 단일 홈페이지 최적화: 기본 사이트("gods") 생성 또는 업데이트
5. `GET /sites` - 단일 홈페이지 최적화: 항상 "gods" 사이트만 반환
6. `GET /sites/default` - 단일 홈페이지 최적화: 항상 "gods" 사이트 반환
7. 프론트엔드 필드명 매핑 지원 (`base_url` -> `homepage_url`, `api_url` -> `api_base`)

## 📋 해결 방법

### 1. Settings 저장 API 추가

**문제**: 프론트엔드가 `PUT /sites/:id` 또는 `PUT /admin/sites/:id`를 호출하지만 엔드포인트가 없음

**해결**: 두 엔드포인트 모두 추가

```javascript
// PUT /sites/:id (공개 API)
app.put("/sites/:id", async (request, reply) => {
  const { id: siteId } = request.params;
  const { name, domain, homepage_url, api_base, base_url, api_url, facebook_key } = request.body;
  
  // 필드명 매핑
  const homepageUrl = homepage_url || base_url;
  const apiBase = api_base || api_url;
  
  // site_id를 문자열로 변환
  const targetSiteId = String(siteId);
  
  // 사이트 업데이트
  db.prepare("UPDATE sites SET name = ?, domain = ?, homepage_url = ?, api_base = ?, facebook_key = ? WHERE id = ?")
    .run(name, domain, homepageUrl, apiBase, facebook_key, targetSiteId);
  
  return updatedSite;
});

// PUT /admin/sites/:id (Admin 전용)
app.put("/admin/sites/:id", { preHandler: [authenticate, requireAdmin] }, ...);
```

### 2. 단일 홈페이지 최적화

**목표**: CMS가 `https://www.godcomfortword.com/` 홈페이지용으로만 사용됨

**해결**:
- 모든 sites API가 기본 사이트("gods")를 사용하도록 최적화
- `GET /sites`: 항상 "gods" 사이트만 반환
- `GET /sites/default`: 항상 "gods" 사이트 반환
- `POST /sites`: 기본 사이트가 있으면 업데이트, 없으면 생성
- `POST /admin/sites`: 기본 사이트가 있으면 업데이트, 없으면 생성

```javascript
// 단일 홈페이지 최적화: 기본 사이트("gods") 사용
const defaultSiteId = "gods";

// GET /sites - 항상 "gods" 사이트만 반환
app.get("/sites", async (request, reply) => {
  const defaultSite = db.prepare("SELECT ... FROM sites WHERE id = ?").get(defaultSiteId);
  return defaultSite ? [defaultSite] : [];
});

// POST /sites - 기본 사이트가 있으면 업데이트, 없으면 생성
app.post("/sites", async (request, reply) => {
  const existingSite = db.prepare("SELECT * FROM sites WHERE id = ?").get(defaultSiteId);
  
  if (existingSite) {
    // 업데이트
    db.prepare("UPDATE sites SET ... WHERE id = ?").run(...);
  } else {
    // 생성
    db.prepare("INSERT INTO sites ...").run(...);
  }
});
```

### 3. 프론트엔드 필드명 매핑

**문제**: 프론트엔드가 `base_url`, `api_url`을 보내지만 백엔드는 `homepage_url`, `api_base`를 사용

**해결**: 두 필드명 모두 지원

```javascript
// 필드명 매핑 (프론트엔드 호환성)
const homepageUrl = homepage_url || base_url;
const apiBase = api_base || api_url;
```

### 4. site_id 문자열 통일

**문제**: 프론트엔드가 숫자 `site_id`를 보내지만 DB는 문자열 사용

**해결**: 모든 엔드포인트에서 `site_id`를 문자열로 변환

```javascript
// site_id를 문자열로 변환
const targetSiteId = String(siteId);
```

## 🧪 테스트 시나리오

### 시나리오 1: Settings 저장 (기본 사이트 업데이트)

```javascript
// 프론트엔드 요청
PUT /sites/gods
{
  "name": "God's Comfort Word",
  "base_url": "https://www.godcomfortword.com/",
  "api_url": "http://localhost:8787"
}

// 백엔드 처리
1. site_id를 문자열로 변환: "gods"
2. 필드명 매핑: base_url -> homepage_url, api_url -> api_base
3. 기본 사이트("gods") 업데이트
4. 업데이트된 사이트 반환
```

### 시나리오 2: Settings 저장 (기본 사이트 생성)

```javascript
// 프론트엔드 요청
POST /sites
{
  "name": "God's Comfort Word",
  "base_url": "https://www.godcomfortword.com/",
  "api_url": "http://localhost:8787"
}

// 백엔드 처리
1. 기본 사이트("gods") 확인: 없음
2. 기본 사이트 생성
3. 생성된 사이트 반환
```

### 시나리오 3: 사이트 목록 조회

```javascript
// 프론트엔드 요청
GET /sites

// 백엔드 처리
1. 기본 사이트("gods") 조회
2. 기본 사이트만 배열로 반환: [{ id: "gods", ... }]
```

## ✅ 최종 확인 사항

- [x] PUT /sites/:id 엔드포인트 추가
- [x] PUT /admin/sites/:id 엔드포인트 추가
- [x] POST /sites - 기본 사이트 생성 또는 업데이트
- [x] POST /admin/sites - 기본 사이트 생성 또는 업데이트
- [x] GET /sites - 항상 "gods" 사이트만 반환
- [x] GET /sites/default - 항상 "gods" 사이트 반환
- [x] 프론트엔드 필드명 매핑 지원
- [x] site_id 문자열 통일

## 📝 참고사항

1. **단일 홈페이지 최적화**:
   - 모든 sites API가 기본 사이트("gods")를 사용
   - `https://www.godcomfortword.com/` 홈페이지에 최적화
   - Settings에서 저장 시 항상 "gods" 사이트 업데이트

2. **필드명 호환성**:
   - 프론트엔드: `base_url`, `api_url`
   - 백엔드: `homepage_url`, `api_base`
   - 두 필드명 모두 지원하여 호환성 유지

3. **site_id 처리**:
   - 프론트엔드가 숫자로 보내도 문자열로 변환
   - DB에는 항상 문자열로 저장
   - 기본 사이트 ID: `"gods"`

4. **기본 사이트 보장**:
   - sites 테이블이 비어있으면 자동 생성
   - 모든 API가 기본 사이트를 사용하도록 보장

CMS Settings에서 사이트 정보 저장이 정상적으로 작동하며, 단일 홈페이지(`https://www.godcomfortword.com/`)에 최적화되었습니다.


























