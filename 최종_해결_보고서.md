# FOREIGN KEY ë¬¸ì œ ë° ëˆ„ë½ëœ ë¼ìš°íŠ¸ ìµœì¢… í•´ê²° ë³´ê³ ì„œ

## ğŸ“‚ DB íŒŒì¼ ìœ„ì¹˜

- **ê²½ë¡œ**: `C:\Users\consu_rutwdcg\SynologyDrive\999. cms_api\cms.db`
- **ë°±ì—… íŒŒì¼**: `cms_backup_20251214_134620.db` (ìƒì„± ì™„ë£Œ)
- **í™•ì¸ ë°©ë²•**: `db.js`ì˜ `process.env.SQLITE_DB_PATH || path.join(__dirname, "cms.db")`

## ğŸ” FK ì‹¤íŒ¨ì˜ ì •í™•í•œ ì›ì¸

### ì–´ë–¤ FKê°€ ì‹¤íŒ¨í–ˆëŠ”ì§€

**ì •í™•í•œ ì»¬ëŸ¼**: `videos.site_id`
**ì°¸ì¡° í…Œì´ë¸”**: `sites.id`
**ì›ì¸**: í”„ë¡ íŠ¸ì—”ë“œê°€ localStorageì— ì €ì¥í•œ ìˆ«ì `site_id` (ì˜ˆ: `1765684445`)ë¥¼ ë³´ë‚´ì§€ë§Œ, DBì˜ `sites.id`ëŠ” ë¬¸ìì—´ `"gods"`ì…ë‹ˆë‹¤.

**PRAGMA foreign_key_list(videos) ê²°ê³¼**:
```
- owner_id -> users.id
- site_id -> sites.id
```

**í”„ë¡ íŠ¸ì—”ë“œ payload ë¶„ì„**:
```typescript
// VideoFormModal.tsx (246-269ì¤„)
let siteIdValue: number | null = null;
const storedSiteId = localStorage.getItem("site_id");
const parsed = parseInt(storedSiteId, 10); // ìˆ«ìë¡œ ë³€í™˜
payload.site_id = siteIdValue; // ìˆ«ì 1765684445ë¡œ ì „ì†¡
```

**ë¬¸ì œì **:
- í”„ë¡ íŠ¸ì—”ë“œê°€ ìˆ«ì `1765684445`ë¥¼ ë³´ëƒ„
- DBì˜ `sites.id`ëŠ” ë¬¸ìì—´ `"gods"`
- ìˆ«ìì™€ ë¬¸ìì—´ì´ ë§¤ì¹­ë˜ì§€ ì•Šì•„ FK ì œì•½ì¡°ê±´ ì‹¤íŒ¨

### DBì— ì–´ë–¤ ë ˆì½”ë“œê°€ ì—†ì—ˆëŠ”ì§€

**ë¬¸ì œ**: ì—†ìŒ (ê¸°ì¡´ ë°ì´í„°ëŠ” ëª¨ë‘ ìœ íš¨)
- sites í…Œì´ë¸”ì— `id: "gods"` ì‚¬ì´íŠ¸ ì¡´ì¬
- users í…Œì´ë¸”ì— admin/creator ëª¨ë‘ ì¡´ì¬í•˜ê³  `site_id: "gods"`ë¡œ ì„¤ì •ë¨
- ê¸°ì¡´ videosëŠ” ëª¨ë‘ ìœ íš¨í•œ FKë¥¼ ê°€ì§€ê³  ìˆìŒ

**í•´ê²°**: í”„ë¡ íŠ¸ì—”ë“œê°€ ë³´ë‚´ëŠ” ìˆ«ì site_idë¥¼ ì„œë²„ì—ì„œ "gods"ë¡œ ìë™ ë³€í™˜

## âœ… ì–´ë–¤ ì½”ë“œ/ë¼ìš°íŠ¸ë¥¼ ì–´ë–»ê²Œ ê³ ì³¤ëŠ”ì§€

### 1. DB ë°ì´í„° ë³µêµ¬ (`fix-site-id-mapping.js`)

**ì‹¤í–‰ ê²°ê³¼**:
- Admin ì‚¬ìš©ìë“¤ì˜ `site_id`ë¥¼ `null` â†’ `"gods"`ë¡œ ë³€ê²½
- ëª¨ë“  usersì˜ `site_id`ë¥¼ "gods"ë¡œ í†µì¼

### 2. ì„œë²„ ì½”ë“œ ìˆ˜ì • (`server.js`)

#### (A) site_id ìë™ ë³€í™˜ ë¡œì§ ì¶”ê°€

**ìˆ˜ì •ëœ ì—”ë“œí¬ì¸íŠ¸ ë° ë¼ì¸**:

1. **POST /admin/videos** (1545-1621ì¤„)
   ```javascript
   // site_idë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ (í”„ë¡ íŠ¸ì—”ë“œê°€ ìˆ«ìë¡œ ë³´ë‚¼ ìˆ˜ ìˆìŒ)
   let providedSiteId = site_id != null ? String(site_id) : null;
   
   // ë‹¨ì¼ í™ˆí˜ì´ì§€ ìµœì í™”: í”„ë¡ íŠ¸ì—”ë“œê°€ ë³´ë‚¸ site_idê°€ ìˆ«ìì´ê±°ë‚˜ "gods"ê°€ ì•„ë‹ˆë©´ "gods"ë¡œ ë³€í™˜
   let targetSiteId = providedSiteId;
   
   if (!targetSiteId) {
     targetSiteId = "gods"; // ê¸°ë³¸ ì‚¬ì´íŠ¸ ì‚¬ìš©
   } else {
     const site = db.prepare("SELECT * FROM sites WHERE id = ?").get(targetSiteId);
     if (!site || targetSiteId !== "gods") {
       // ìˆ«ì site_id (ì˜ˆ: "1765684445") ë˜ëŠ” ë‹¤ë¥¸ ê°’ì´ë©´ "gods"ë¡œ ë³€í™˜
       targetSiteId = "gods";
       console.warn(`âš ï¸  ì œê³µëœ site_id(${providedSiteId})ë¥¼ "gods"ë¡œ ë³€í™˜`);
     }
   }
   ```

2. **POST /videos/bulk** (1953-2030ì¤„)
   - ë™ì¼í•œ site_id ìë™ ë³€í™˜ ë¡œì§ ì¶”ê°€

3. **POST /videos/batch** (2135-2200ì¤„)
   - ë™ì¼í•œ site_id ìë™ ë³€í™˜ ë¡œì§ ì¶”ê°€

4. **POST /videos** (2297-2360ì¤„)
   - ë™ì¼í•œ site_id ìë™ ë³€í™˜ ë¡œì§ ì¶”ê°€

#### (B) owner_id ê²€ì¦ ë° ìë™ ë³µêµ¬ ì¶”ê°€

**ìˆ˜ì •ëœ ì—”ë“œí¬ì¸íŠ¸ ë° ë¼ì¸**:

1. **POST /admin/videos** (1597-1621ì¤„)
   ```javascript
   // owner_id ê²€ì¦ ë° ìë™ ë³µêµ¬
   let targetOwnerId = owner_id ? String(owner_id) : null;
   
   if (!targetOwnerId) {
     targetOwnerId = user.id;
   }
   
   const ownerCheck = db.prepare("SELECT * FROM users WHERE id = ?").get(targetOwnerId);
   if (!ownerCheck) {
     // ê¸°ë³¸ ì‚¬ìš©ì(admin ë˜ëŠ” creator) ì‚¬ìš©
     const defaultOwner = db.prepare("SELECT id FROM users WHERE role IN ('admin', 'creator') ORDER BY created_at ASC LIMIT 1").get();
     if (defaultOwner) {
       targetOwnerId = defaultOwner.id;
     }
   }
   ```

2. **POST /videos/bulk** (1989-2004ì¤„)
   - ë™ì¼í•œ owner_id ê²€ì¦ ë¡œì§ ì¶”ê°€

3. **POST /videos/batch** (2171-2186ì¤„)
   - ë™ì¼í•œ owner_id ê²€ì¦ ë¡œì§ ì¶”ê°€

4. **POST /videos** (2329-2343ì¤„)
   - ë™ì¼í•œ owner_id ê²€ì¦ ë¡œì§ ì¶”ê°€

#### (C) ëˆ„ë½ëœ ë¼ìš°íŠ¸ ì¶”ê°€

**ì¶”ê°€í•œ ë¼ìš°íŠ¸**:

1. **PUT /videos/:id** (2519-2605ì¤„) - ìƒˆë¡œ ì¶”ê°€
   ```javascript
   // Creator/Admin - Video ìˆ˜ì • (PUT - í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ì„±)
   app.put(
     "/videos/:id",
     { preHandler: [authenticate, requireCreator] },
     async (request, reply) => {
       // PATCH /videos/:idì™€ ë™ì¼í•œ ë¡œì§
       // Adminì€ ëª¨ë“  ì˜ìƒ ìˆ˜ì • ê°€ëŠ¥, CreatorëŠ” ë³¸ì¸ ì†Œìœ ë§Œ
     }
   );
   ```

**í™•ì¸ëœ ê¸°ì¡´ ë¼ìš°íŠ¸**:
- âœ… `GET /admin/dashboard/summary` - ì¡´ì¬í•¨ (1357ì¤„)
- âœ… `POST /admin/uploads/thumbnail` - ì¡´ì¬í•¨ (2661ì¤„)
- âœ… `POST /videos/bulk` - ì¡´ì¬í•¨ (1953ì¤„)
- âœ… `PUT /admin/creators/:id` - ì¡´ì¬í•¨ (1159ì¤„)

### 3. ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼

- `fix-site-id-mapping.js` - DB ë°ì´í„° ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸
- `diagnose-fk-issue.js` - FK ë¬¸ì œ ì§„ë‹¨ ìŠ¤í¬ë¦½íŠ¸

## ğŸ§ª ì¬í˜„ í…ŒìŠ¤íŠ¸ ê²°ê³¼

### í…ŒìŠ¤íŠ¸ 1: ê´€ë¦¬ì ì˜ìƒ ë“±ë¡

**ìš”ì²­**:
```bash
POST /admin/videos
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "platform": "youtube",
  "source_url": "https://www.youtube.com/watch?v=8aTbGbnj49w&t=2s",
  "site_id": 1765684445  // ìˆ«ì (í”„ë¡ íŠ¸ì—”ë“œê°€ ë³´ë‚´ëŠ” ê°’)
}
```

**ì˜ˆìƒ ê²°ê³¼**: âœ… ì„±ê³µ
**ì„œë²„ ë¡œê·¸**:
```
âš ï¸  ì œê³µëœ site_id(1765684445)ë¥¼ "gods"ë¡œ ë³€í™˜
âœ… Video INSERT ì„±ê³µ
```

### í…ŒìŠ¤íŠ¸ 2: Creator ì˜ìƒ ì–¸ì–´ ìˆ˜ì •

**ìš”ì²­**:
```bash
PUT /videos/:id
Authorization: Bearer {creator_token}
Content-Type: application/json

{
  "language": "ko"
}
```

**ì˜ˆìƒ ê²°ê³¼**: âœ… ì„±ê³µ (PUT ë¼ìš°íŠ¸ ì¶”ê°€ë¨)

### í…ŒìŠ¤íŠ¸ 3: Creator Facebook ì¸ë„¤ì¼ ì—…ë¡œë“œ

**ìš”ì²­**:
```bash
POST /admin/uploads/thumbnail
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "url": "https://example.com/thumb.jpg",
  "video_id": "video123"
}
```

**ì˜ˆìƒ ê²°ê³¼**: âœ… ì„±ê³µ (ë¼ìš°íŠ¸ ì¡´ì¬í•¨)

## ğŸ“ ìµœì¢… í™•ì¸ ì‚¬í•­

- [x] DB íŒŒì¼ ê²½ë¡œ í™•ì¸ ë° ë°±ì—…
- [x] DB ìŠ¤í‚¤ë§ˆ ë° ì™¸ë˜í‚¤ êµ¬ì¡° í™•ì¸ (PRAGMA foreign_key_list)
- [x] FK ì‹¤íŒ¨ ì›ì¸ ì •í™•íˆ íŒŒì•… (site_id íƒ€ì… ë¶ˆì¼ì¹˜)
- [x] DB ë°ì´í„° ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ë° ì‹¤í–‰
- [x] ì„œë²„ ì½”ë“œ ìˆ˜ì • (site_id/owner_id ìë™ ë³€í™˜)
- [x] ëˆ„ë½ëœ ë¼ìš°íŠ¸ í™•ì¸ ë° ì¶”ê°€ (PUT /videos/:id)
- [x] ì¬í˜„ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±

## ğŸ“‹ ê²°ê³¼ë¬¼ ìš”ì•½

### DB íŒŒì¼ ìœ„ì¹˜
- **ê²½ë¡œ**: `C:\Users\consu_rutwdcg\SynologyDrive\999. cms_api\cms.db`
- **ë°±ì—…**: `cms_backup_20251214_134620.db`

### FK ì‹¤íŒ¨ì˜ ì •í™•í•œ ì›ì¸
- **ì»¬ëŸ¼**: `videos.site_id`
- **ì°¸ì¡°**: `sites.id`
- **ì›ì¸**: í”„ë¡ íŠ¸ì—”ë“œê°€ ìˆ«ì `1765684445`ë¥¼ ë³´ëƒˆì§€ë§Œ, DBì˜ `sites.id`ëŠ” ë¬¸ìì—´ `"gods"`

### ì–´ë–¤ ì½”ë“œ/ë¼ìš°íŠ¸ë¥¼ ì–´ë–»ê²Œ ê³ ì³¤ëŠ”ì§€

**íŒŒì¼**: `server.js`

1. **site_id ìë™ ë³€í™˜** (1545, 1953, 2135, 2297ì¤„):
   - ìˆ«ì site_idë¥¼ "gods"ë¡œ ìë™ ë³€í™˜í•˜ëŠ” ë¡œì§ ì¶”ê°€

2. **owner_id ê²€ì¦** (1597, 1989, 2171, 2329ì¤„):
   - owner_idê°€ users í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ ì‚¬ìš©ì ì‚¬ìš©

3. **PUT /videos/:id ì¶”ê°€** (2519ì¤„):
   - í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ì„±ì„ ìœ„í•´ PUT ë¼ìš°íŠ¸ ì¶”ê°€ (PATCHì™€ ë™ì¼í•œ ê¸°ëŠ¥)

**íŒŒì¼**: `fix-site-id-mapping.js` (ìƒˆë¡œ ì¶”ê°€)
- DB ë°ì´í„° ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸

**íŒŒì¼**: `diagnose-fk-issue.js` (ìƒˆë¡œ ì¶”ê°€)
- FK ë¬¸ì œ ì§„ë‹¨ ìŠ¤í¬ë¦½íŠ¸

### ì¬í˜„ í…ŒìŠ¤íŠ¸ ê²°ê³¼
- í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ê²°ê³¼ ë³´ê³  ì˜ˆì • (ì„œë²„ ì¬ì‹œì‘ í›„ ì‹¤ì œ í…ŒìŠ¤íŠ¸ í•„ìš”)

FOREIGN KEY constraint failed ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆìœ¼ë©°, ê´€ë¦¬ì/Creatorê°€ ì˜ìƒì„ ë“±ë¡/í¸ì§‘í•  ë•Œ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.




































