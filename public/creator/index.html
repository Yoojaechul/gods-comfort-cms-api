<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMS Creator</title>
  <link rel="stylesheet" href="/creator/creator.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¨ CMS Creator Panel</h1>
      <div id="userDisplay" class="user-info"></div>
      <button onclick="logout()" class="logout-button">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ì˜ìƒ ê´€ë¦¬ -->
    <div class="section">
      <h2>ë‚´ ì˜ìƒ ëª©ë¡</h2>
      <button onclick="loadVideos()" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
      <div id="videosList"></div>
    </div>

    <!-- ì˜ìƒ ë“±ë¡ -->
    <div class="section">
      <h2>ì˜ìƒ ë“±ë¡</h2>
      <div class="form-group">
        <label>í”Œë«í¼</label>
        <select id="platformSelect">
          <option value="youtube">YouTube</option>
          <option value="facebook">Facebook</option>
          <option value="other">ê¸°íƒ€</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì˜ìƒ URL</label>
        <input type="text" id="sourceUrlInput" placeholder="https://www.youtube.com/watch?v=...">
      </div>
      <div class="form-group">
        <label>ì œëª© (ì„ íƒì‚¬í•­ - ìë™ ìƒì„±ë¨)</label>
        <input type="text" id="titleInput" placeholder="ì œëª©ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤">
      </div>
      <div class="form-group">
        <label>ì¸ë„¤ì¼ URL (ì„ íƒì‚¬í•­ - ìë™ ìƒì„±ë¨)</label>
        <input type="text" id="thumbnailInput" placeholder="ì¸ë„¤ì¼ URLì„ ì…ë ¥í•˜ê±°ë‚˜ ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤">
      </div>
      <div class="form-group">
        <label>ê³µê°œ ì„¤ì •</label>
        <select id="visibilitySelect">
          <option value="public">ê³µê°œ</option>
          <option value="private">ë¹„ê³µê°œ</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì–¸ì–´</label>
        <select id="languageSelect">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">ì˜ì–´</option>
          <option value="es">ìŠ¤í˜ì¸ì–´</option>
          <option value="zh">ì¤‘êµ­ì–´</option>
        </select>
      </div>
      <button onclick="createVideo()">ì˜ìƒ ë“±ë¡</button>
    </div>
  </div>

  <!-- ë¹„ë””ì˜¤ ëª¨ë‹¬ -->
  <div id="videoModal" class="video-modal hidden">
    <div class="video-modal-backdrop" onclick="closeVideoModal()"></div>
    <div class="video-modal-content">
      <button class="video-modal-close" onclick="closeVideoModal()">Ã—</button>
      <div id="videoModalInner"></div>
    </div>
  </div>

  <script src="/creator/creator.js" 
          onerror="console.error('[index.html] creator.js ë¡œë“œ ì‹¤íŒ¨!'); alert('âš ï¸ creator.js íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');"
          onload="console.log('[index.html] creator.js ë¡œë“œ ì„±ê³µ (200 OK)');">
  </script>
  <script>
    // loadVideos() í•¨ìˆ˜ëŠ” creator.jsì— ì •ì˜ë˜ì–´ ìˆìŒ
    // creator.js ë‚´ë¶€ì—ì„œ DOMContentLoaded ì´ë²¤íŠ¸ë¡œ ìë™ í˜¸ì¶œë¨

    // ì˜ìƒ ë“±ë¡
    async function createVideo() {
      const token = getToken();
      if (!token) {
        checkAuth();
        return;
      }

      // NEST_API_BASE í™•ì¸
      const apiBase = window.NEST_API_BASE || NEST_API_BASE || 'http://localhost:8788';
      if (!apiBase) {
        console.error('[createVideo] NEST_API_BASEë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const platform = document.getElementById('platformSelect').value;
      const sourceUrl = document.getElementById('sourceUrlInput').value.trim();
      const title = document.getElementById('titleInput').value.trim();
      const thumbnail = document.getElementById('thumbnailInput').value.trim();
      const visibility = document.getElementById('visibilitySelect').value;
      const language = document.getElementById('languageSelect').value;

      if (!sourceUrl) {
        alert('ì˜ìƒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      console.log('[createVideo] ì˜ìƒ ë“±ë¡ ìš”ì²­ ì‹œì‘');
      console.log('[createVideo] API Base:', apiBase);
      console.log('[createVideo] URL:', sourceUrl);
      console.log('[createVideo] Platform:', platform);

      try {
        // NestJS APIë¡œ ìš”ì²­
        const requestUrl = `${apiBase}/videos`;
        console.log('[createVideo] ìš”ì²­ URL:', requestUrl);

        const res = await fetch(requestUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            url: sourceUrl,
            title: title || undefined,
            thumbnailUrl: thumbnail || undefined,
            platform: platform,
            visibility: visibility || 'public',
            language: language || 'ko'
          })
        });

        console.log('[createVideo] ì‘ë‹µ ìƒíƒœ:', res.status, res.statusText);

        if (res.status === 401 || res.status === 403) {
          console.error('[createVideo] ì¸ì¦ ì‹¤íŒ¨ - ìƒíƒœ ì½”ë“œ:', res.status);
          alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          logout();
          return;
        }

        const data = await res.json();
        console.log('[createVideo] ì‘ë‹µ ë°ì´í„°:', data);

        if (!res.ok) {
          const errorMessage = data.message || data.error || 'ì˜ìƒ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          console.error('[createVideo] ì„œë²„ ì˜¤ë¥˜:', {
            status: res.status,
            statusText: res.statusText,
            error: errorMessage,
            data: data
          });
          // alert ëŒ€ì‹  console.errorë§Œ ì‚¬ìš©
          console.error('[createVideo] ì˜ìƒ ë“±ë¡ ì‹¤íŒ¨:', errorMessage);
          return;
        }

        console.log('[createVideo] ì˜ìƒ ë“±ë¡ ì„±ê³µ');
        alert('ì˜ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('sourceUrlInput').value = '';
        document.getElementById('titleInput').value = '';
        document.getElementById('thumbnailInput').value = '';
        
        // ì˜ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        console.log('[createVideo] loadVideos() í˜¸ì¶œí•˜ì—¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
        loadVideos();
      } catch (err) {
        console.error('[createVideo] ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', err);
        console.error('[createVideo] ì˜¤ë¥˜ ìƒì„¸:', {
          message: err.message,
          stack: err.stack,
          name: err.name
        });
        // alert ëŒ€ì‹  console.errorë§Œ ì‚¬ìš©
        console.error('[createVideo] ì˜ìƒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì˜ìƒ ìˆ˜ì • (NestJS API ì‚¬ìš©)
    async function editVideo(id) {
      const newTitle = prompt('ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!newTitle) {
        console.log('[editVideo] ì‚¬ìš©ìê°€ ìˆ˜ì •ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      const token = getToken();
      if (!token) {
        console.error('[editVideo] í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
        alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        checkAuth();
        return;
      }

      const apiBase = window.NEST_API_BASE || NEST_API_BASE || 'http://localhost:8788';
      const requestUrl = `${apiBase}/videos/${id}`;

      console.log('[editVideo] ì˜ìƒ ìˆ˜ì • ìš”ì²­ ì‹œì‘');
      console.log('[editVideo] Video ID:', id);
      console.log('[editVideo] ìš”ì²­ URL:', requestUrl);
      console.log('[editVideo] ìˆ˜ì •í•  ì œëª©:', newTitle);

      try {
        const response = await fetch(requestUrl, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            title: newTitle
          })
        });

        console.log('[editVideo] ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

        if (response.status === 401 || response.status === 403) {
          console.error('[editVideo] ì¸ì¦ ì‹¤íŒ¨ - ìƒíƒœ ì½”ë“œ:', response.status);
          alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          logout();
          return;
        }

        if (response.status === 404) {
          const errorData = await response.json().catch(() => ({}));
          const errorMessage = errorData.message || 'ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          console.error('[editVideo] ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', errorMessage);
          alert('ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (response.status === 403) {
          const errorData = await response.json().catch(() => ({}));
          const errorMessage = errorData.message || 'ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
          console.error('[editVideo] ê¶Œí•œ ì—†ìŒ:', errorMessage);
          alert('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (response.ok) {
          const data = await response.json().catch(() => ({}));
          console.log('[editVideo] ì˜ìƒ ìˆ˜ì • ì„±ê³µ:', data);
          alert('ì˜ìƒì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // ì˜ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          console.log('[editVideo] loadVideos() í˜¸ì¶œí•˜ì—¬ ëª©ë¡ ê°±ì‹ ');
          loadVideos();
          return;
        }

        // ê¸°íƒ€ ì˜¤ë¥˜
        const errorData = await response.json().catch(() => ({}));
        const errorMessage = errorData.message || errorData.error || 'ì˜ìƒ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        console.error('[editVideo] ì„œë²„ ì˜¤ë¥˜:', {
          status: response.status,
          statusText: response.statusText,
          error: errorMessage,
          data: errorData
        });
        alert('ì˜ìƒ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error('[editVideo] ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', err);
        console.error('[editVideo] ì˜¤ë¥˜ ìƒì„¸:', {
          message: err.message,
          stack: err.stack,
          name: err.name
        });
        alert('ì˜ìƒ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì˜ìƒ ì‚­ì œ í•¨ìˆ˜ëŠ” creator.jsì˜ onClickDeleteVideo()ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì¶”ê°€ í™•ì¸ (creator.jsì˜ ìë™ ì´ˆê¸°í™”ê°€ ì‹¤íŒ¨í•œ ê²½ìš° ëŒ€ë¹„)
    window.addEventListener('load', () => {
      console.log('[index.html] window.load ì´ë²¤íŠ¸ ë°œìƒ');
      
      // creator.jsê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (typeof loadVideos === 'undefined') {
        console.error('[index.html] loadVideos í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. creator.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // creator.jsì˜ ìë™ ì´ˆê¸°í™”ê°€ ì´ë¯¸ ì‹¤í–‰ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
      // ì¶”ê°€ë¡œ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (ì¤‘ë³µ ë°©ì§€)
      // ë§Œì•½ ìë™ ì´ˆê¸°í™”ê°€ ì‹¤íŒ¨í–ˆë‹¤ë©´, ì—¬ê¸°ì„œ í•œ ë²ˆ ë” ì‹œë„
      setTimeout(() => {
        const token = typeof getToken !== 'undefined' ? getToken() : null;
        if (token && typeof checkAuth !== 'undefined') {
          const isAuthenticated = checkAuth();
          if (isAuthenticated) {
            console.log('[index.html] window.loadì—ì„œ loadVideos() ì¶”ê°€ í˜¸ì¶œ');
            loadVideos();
          }
        }
      }, 500);   // creator.jsì˜ ìë™ ì´ˆê¸°í™” í›„ ì‹¤í–‰
    });
  </script>
</body>
</html>
